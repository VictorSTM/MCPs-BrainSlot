# Reglas de Desarrollo - BrainSlot MCP

## 🎯 Alineación con Objetivos

### Principio Fundamental
**SIEMPRE** consultar `PROJECT_CONTEXT.md` antes de implementar nuevas funcionalidades. Todo desarrollo debe estar alineado con:
- La fase actual del roadmap
- Los criterios de aceptación definidos
- La arquitectura Control Plane vs Data Plane
- Los objetivos de aislamiento entre entidades

## 📐 Arquitectura y Diseño

### Separación de Responsabilidades
- **Control Plane**: UI, Manager, Registry, Secret Store
- **Data Plane**: MCPs (General + Entidad), Storage, Event Bus
- **NO mezclar** lógica de control con lógica de datos

### Namespacing Estricto
- Recursos: `bs://entities/{entityId}/...` para entidades específicas
- Recursos globales: `bs://datasets/{id}`, `bs://runs/{id}`
- Vector DB: namespace = entityId (aislamiento total)
- Storage: rutas `entities/{id}/...`

### Tools y Scopes
- Implementar `requiresApproval: true` para tools sensibles
- Definir scopes claros: `datasets:read`, `ingest:write`, `train:execute`
- Validar permisos antes de ejecutar cualquier tool

## 🔒 Seguridad Multi-tenant

### Aislamiento Obligatorio
- Cada entidad SOLO puede acceder a su namespace
- Tokens únicos por entidad con rotación
- Validar entityId en TODAS las operaciones
- Sandbox por proceso: dataRoot aislado

### Validaciones de Seguridad
```typescript
// SIEMPRE validar namespace antes de acceder a recursos
if (resourceUri.includes('/entities/') && !resourceUri.includes(`/entities/${ctx.entityId}/`)) {
  throw new Error('Access denied: resource outside entity namespace');
}
```

## 🚀 Fases de Desarrollo

### Fase Actual: **Fase 0 - Consolidación base**
**Prioridad**: Integrar `@modelcontextprotocol/sdk` real
- ✅ Skeleton completado
- 🔄 Integrar SDK MCP oficial
- 🔄 Transports HTTP+SSE funcionales
- 🔄 Cliente MCP puede listar y ejecutar tools

### Reglas por Fase
- **NO avanzar** a la siguiente fase sin completar criterios de aceptación
- **Documentar** cada entregable en PROJECT_CONTEXT.md
- **Probar** funcionalidad con cliente MCP real (CLI/Inspector)

## 🏗️ Stack Técnico Obligatorio

### Core
- **Runtime**: Node.js + TypeScript
- **MCP SDK**: `@modelcontextprotocol/sdk` (oficial)
- **Transports**: stdio (dev), HTTP+SSE (prod)

### Storage
- **Vector DB**: Qdrant/Weaviate/PGVector con namespace=entityId
- **Object Store**: S3-compatible para documentos/artefactos
- **Metadatos**: PostgreSQL para datasets, jobs, runs, manifests
- **Jobs/Events**: Redis Queue o NATS JetStream

### Observabilidad
- **Logs**: JSON estructurado con entityId, jobId, tool, latency
- **Métricas**: Prometheus-compatible
- **Trazas**: distribuidas por jobId

## 📝 Estándares de Código

### Naming Conventions
- **Tools**: `bs.{action}_{resource}` (ej. `bs.ingest_url`, `bs.query_entity`)
- **Resources**: `bs://entities/{entityId}/{resource}` o `bs://{global_resource}/{id}`
- **Variables**: camelCase con prefijo por contexto (`entityId`, `dataRoot`)

### Error Handling
```typescript
// Estructura estándar de errores
interface BrainSlotError {
  code: string;
  message: string;
  entityId?: string;
  details?: Record<string, unknown>;
}
```

### Logging
```typescript
// Estructura estándar de logs
logger.info({
  type: 'tool_execution',
  tool: 'bs.query_entity',
  entityId: ctx.entityId,
  duration_ms: elapsed,
  status: 'success'
});
```

## 🧪 Testing y Calidad

### Testing Obligatorio (desde Fase 6)
- **Unit tests**: cada tool y función core
- **Integration tests**: spawner, registry, storage
- **E2E tests**: cliente MCP real contra servidores

### Criterios de Calidad
- **Coverage**: mínimo 80% en código core
- **Performance**: p95 < 500ms para queries, < 5s para ingesta
- **Security**: tests de aislamiento entre entidades

## 🔄 Proceso de Desarrollo

### Antes de Implementar
1. ✅ Consultar `PROJECT_CONTEXT.md`
2. ✅ Verificar fase actual y criterios
3. ✅ Diseñar con aislamiento de entidades
4. ✅ Definir scopes y permisos necesarios

### Durante el Desarrollo
1. 🔒 Implementar validaciones de seguridad
2. 📊 Añadir logging estructurado
3. 🧪 Escribir tests (desde Fase 6)
4. 📚 Documentar cambios en context

### Después de Implementar
1. ✅ Verificar criterios de aceptación
2. 🧪 Probar con cliente MCP real
3. 📋 Actualizar PROJECT_CONTEXT.md si necesario
4. 🚀 Preparar siguiente milestone

## 🚨 Red Flags - NUNCA Hacer

- ❌ Mezclar datos entre entidades sin validación
- ❌ Hardcodear tokens o credentials
- ❌ Saltar fases del roadmap
- ❌ Implementar sin consultar PROJECT_CONTEXT.md
- ❌ Exponer datos de una entidad a otra
- ❌ Crear tools sin definir scopes
- ❌ Avanzar sin completar criterios de aceptación

## 📋 Checklist de Commit

Antes de cada commit, verificar:
- [ ] Código alineado con fase actual
- [ ] Validaciones de seguridad implementadas
- [ ] Logs estructurados añadidos
- [ ] Namespacing respetado
- [ ] Tests actualizados (si aplica)
- [ ] Documentación actualizada

---

**Recordatorio**: Este proyecto construye infraestructura crítica para IA multi-tenant. La seguridad y el aislamiento son OBLIGATORIOS, no opcionales.
