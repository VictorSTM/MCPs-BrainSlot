# Reglas de Desarrollo - BrainSlot MCP

## ğŸ¯ AlineaciÃ³n con Objetivos

### Principio Fundamental
**SIEMPRE** consultar `PROJECT_CONTEXT.md` antes de implementar nuevas funcionalidades. Todo desarrollo debe estar alineado con:
- La fase actual del roadmap
- Los criterios de aceptaciÃ³n definidos
- La arquitectura Control Plane vs Data Plane
- Los objetivos de aislamiento entre entidades

## ğŸ“ Arquitectura y DiseÃ±o

### SeparaciÃ³n de Responsabilidades
- **Control Plane**: UI, Manager, Registry, Secret Store
- **Data Plane**: MCPs (General + Entidad), Storage, Event Bus
- **NO mezclar** lÃ³gica de control con lÃ³gica de datos

### Namespacing Estricto
- Recursos: `bs://entities/{entityId}/...` para entidades especÃ­ficas
- Recursos globales: `bs://datasets/{id}`, `bs://runs/{id}`
- Vector DB: namespace = entityId (aislamiento total)
- Storage: rutas `entities/{id}/...`

### Tools y Scopes
- Implementar `requiresApproval: true` para tools sensibles
- Definir scopes claros: `datasets:read`, `ingest:write`, `train:execute`
- Validar permisos antes de ejecutar cualquier tool

## ğŸ”’ Seguridad Multi-tenant

### Aislamiento Obligatorio
- Cada entidad SOLO puede acceder a su namespace
- Tokens Ãºnicos por entidad con rotaciÃ³n
- Validar entityId en TODAS las operaciones
- Sandbox por proceso: dataRoot aislado

### Validaciones de Seguridad
```typescript
// SIEMPRE validar namespace antes de acceder a recursos
if (resourceUri.includes('/entities/') && !resourceUri.includes(`/entities/${ctx.entityId}/`)) {
  throw new Error('Access denied: resource outside entity namespace');
}
```

## ğŸš€ Fases de Desarrollo

### Fase Actual: **Fase 0 - ConsolidaciÃ³n base**
**Prioridad**: Integrar `@modelcontextprotocol/sdk` real
- âœ… Skeleton completado
- ğŸ”„ Integrar SDK MCP oficial
- ğŸ”„ Transports HTTP+SSE funcionales
- ğŸ”„ Cliente MCP puede listar y ejecutar tools

### Reglas por Fase
- **NO avanzar** a la siguiente fase sin completar criterios de aceptaciÃ³n
- **Documentar** cada entregable en PROJECT_CONTEXT.md
- **Probar** funcionalidad con cliente MCP real (CLI/Inspector)

## ğŸ—ï¸ Stack TÃ©cnico Obligatorio

### Core
- **Runtime**: Node.js + TypeScript
- **MCP SDK**: `@modelcontextprotocol/sdk` (oficial)
- **Transports**: stdio (dev), HTTP+SSE (prod)

### Storage
- **Vector DB**: Qdrant/Weaviate/PGVector con namespace=entityId
- **Object Store**: S3-compatible para documentos/artefactos
- **Metadatos**: PostgreSQL para datasets, jobs, runs, manifests
- **Jobs/Events**: Redis Queue o NATS JetStream

### Observabilidad
- **Logs**: JSON estructurado con entityId, jobId, tool, latency
- **MÃ©tricas**: Prometheus-compatible
- **Trazas**: distribuidas por jobId

## ğŸ“ EstÃ¡ndares de CÃ³digo

### Naming Conventions
- **Tools**: `bs.{action}_{resource}` (ej. `bs.ingest_url`, `bs.query_entity`)
- **Resources**: `bs://entities/{entityId}/{resource}` o `bs://{global_resource}/{id}`
- **Variables**: camelCase con prefijo por contexto (`entityId`, `dataRoot`)

### Error Handling
```typescript
// Estructura estÃ¡ndar de errores
interface BrainSlotError {
  code: string;
  message: string;
  entityId?: string;
  details?: Record<string, unknown>;
}
```

### Logging
```typescript
// Estructura estÃ¡ndar de logs
logger.info({
  type: 'tool_execution',
  tool: 'bs.query_entity',
  entityId: ctx.entityId,
  duration_ms: elapsed,
  status: 'success'
});
```

## ğŸ§ª Testing y Calidad

### Testing Obligatorio (desde Fase 6)
- **Unit tests**: cada tool y funciÃ³n core
- **Integration tests**: spawner, registry, storage
- **E2E tests**: cliente MCP real contra servidores

### Criterios de Calidad
- **Coverage**: mÃ­nimo 80% en cÃ³digo core
- **Performance**: p95 < 500ms para queries, < 5s para ingesta
- **Security**: tests de aislamiento entre entidades

## ğŸ”„ Proceso de Desarrollo

### Antes de Implementar
1. âœ… Consultar `PROJECT_CONTEXT.md`
2. âœ… Verificar fase actual y criterios
3. âœ… DiseÃ±ar con aislamiento de entidades
4. âœ… Definir scopes y permisos necesarios

### Durante el Desarrollo
1. ğŸ”’ Implementar validaciones de seguridad
2. ğŸ“Š AÃ±adir logging estructurado
3. ğŸ§ª Escribir tests (desde Fase 6)
4. ğŸ“š Documentar cambios en context

### DespuÃ©s de Implementar
1. âœ… Verificar criterios de aceptaciÃ³n
2. ğŸ§ª Probar con cliente MCP real
3. ğŸ“‹ Actualizar PROJECT_CONTEXT.md si necesario
4. ğŸš€ Preparar siguiente milestone

## ğŸš¨ Red Flags - NUNCA Hacer

- âŒ Mezclar datos entre entidades sin validaciÃ³n
- âŒ Hardcodear tokens o credentials
- âŒ Saltar fases del roadmap
- âŒ Implementar sin consultar PROJECT_CONTEXT.md
- âŒ Exponer datos de una entidad a otra
- âŒ Crear tools sin definir scopes
- âŒ Avanzar sin completar criterios de aceptaciÃ³n

## ğŸ“‹ Checklist de Commit

Antes de cada commit, verificar:
- [ ] CÃ³digo alineado con fase actual
- [ ] Validaciones de seguridad implementadas
- [ ] Logs estructurados aÃ±adidos
- [ ] Namespacing respetado
- [ ] Tests actualizados (si aplica)
- [ ] DocumentaciÃ³n actualizada

---

**Recordatorio**: Este proyecto construye infraestructura crÃ­tica para IA multi-tenant. La seguridad y el aislamiento son OBLIGATORIOS, no opcionales.
